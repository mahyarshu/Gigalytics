1) Create dim_event_type
==========================

drop table if exists dim_event_type cascade;

-- Creating dim_event_type dimension 

CREATE TABLE dim_event_type (type_id int2 NOT NULL GENERATED BY DEFAULT AS identity,type_name text NULL);

--Inserting data into dim_event_type table

insert into dim_event_type(type_name) select distinct event_type from songkick_uk_events;

--Enforcing primary key constraint 

ALTER TABLE dim_event_type ADD CONSTRAINT dim_event_type_pk PRIMARY KEY (type_id);

--select * from dim_event_type;
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

2) Create dim_time
======================

drop table if exists dim_time cascade;

--Creating time dimension 

create table dim_time as
SELECT distinct to_char(start_date, 'yyyymm') as time_id, 
to_char(start_date, 'yyyy') as year,
to_char(start_date, 'mm') as month
FROM songkick_uk_events
order by 1;

--Enforcing primary key constraint

ALTER TABLE dim_time ADD CONSTRAINT dim_time_pk PRIMARY KEY (time_id);

@@@@@@@@@@@@@@@@@@@@@

3) Creating dim_event_start_time
================================

drop table if exists dim_event_start_time cascade;

--Creating event_start_time diemnsion 

create table dim_event_start_time as
SELECT distinct to_char(start_time, 'HH24MI') as start_time_id, 
to_char(start_time, 'HH24') as hour_of_day,
start_time
FROM songkick_uk_events
where to_char(start_time, 'HH24MI') != '1111' --exclude events with missing start time - total of 20934 (30%) out of 69335 events
order by 1;

.
.
@@@@@@@@@@@@@@@@@@@@@@@@
update songkick_uk_events 
set start_time = null
where to_char(start_time, 'HH24MI') = '1111'
@@@@@@@@@@@@@@@@@@@@@@@@


--Enforcing primary key constraint

ALTER TABLE dim_event_start_time ADD CONSTRAINT dim_event_start_time_pk PRIMARY KEY (start_time_id);


4) Creating Fact table 
========================

--Creating the FACT table

create table fct_ukLiveMusicEvent as
select a.time_id, b.type_id, e.start_time_id, count(c.event_id) as no_of_events 
from dim_time a, dim_event_type b, songkick_uk_events c, dim_event_start_time e
where c.country = 'UK' and c.event_type = b.type_name
and a.time_id = to_char(c.start_date, 'yyyy') || to_char(c.start_date, 'mm') --|| to_char(c.start_date, 'iw')
and e.start_time_id = to_char(c.start_time, 'HH24MI') or c.start_time is null
group by a.time_id, b.type_id,e.start_time_id
order by type_id, time_id asc, e.start_time_id asc;

.
.

-- Enforcing primary key index

ALTER TABLE fct_ukLiveMusicEvent ADD CONSTRAINT fct_ukLiveMusicEvent_pk PRIMARY KEY (time_id,type_id, start_time_id);

-- Enforfing referential integrrity on the FACT table 

ALTER TABLE fct_ukLiveMusicEvent ADD CONSTRAINT fct_ukLiveMusicEvent_fk_1 FOREIGN KEY (start_time_id) REFERENCES dim_event_start_time(start_time_id);
ALTER TABLE fct_ukLiveMusicEvent ADD CONSTRAINT fct_ukLiveMusicEvent_fk_2 FOREIGN KEY (type_id) REFERENCES dim_event_type(type_id);
ALTER TABLE fct_ukLiveMusicEvent ADD CONSTRAINT fct_ukLiveMusicEvent_fk_3 FOREIGN KEY (time_id) REFERENCES dim_time(time_id)


